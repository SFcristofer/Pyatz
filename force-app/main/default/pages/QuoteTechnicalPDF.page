<apex:page standardController="Quote" extensions="QuoteTechnicalPDFController" renderAs="pdf" showHeader="false" sidebar="false" standardStylesheets="false" applyBodyTag="false" applyHtmlTag="false">
    <html>
        <head>
            <style type="text/css">
                @page { 
                    size: letter; 
                    margin: 0.5cm 0.5cm 2.5cm 0.5cm; 
                    @bottom-right {
                        content: "Página " counter(page) " de " counter(pages);
                        font-family: 'Helvetica', 'Arial', sans-serif;
                        font-size: 8pt;
                        color: #666;
                        padding-right: 20pt;
                        vertical-align: top;
                        padding-top: 10pt;
                    }
                }
                body { font-family: 'Helvetica', 'Arial', sans-serif; font-size: 10pt; color: #333; line-height: 1.3; margin: 0; padding: 0; }
                
                .header-img { width: 100%; margin-bottom: 10pt; display: block; }
                .footer-img { width: 100%; position: fixed; bottom: 0; left: 0; display: block; z-index: -1; }
                
                .content-body { padding: 0 20pt; }
                
                .title-quote { font-size: 16pt; font-weight: bold; margin-bottom: 2pt; color: #000; }
                .line-business { font-size: 11pt; color: #333; margin-bottom: 12pt; font-weight: normal; }
                .data-label { font-weight: bold; width: 85px; display: inline-block; }
                .client-name { font-size: 14pt; font-weight: bold; margin-top: 15pt; }
                
                .table-services { width: 100%; border-collapse: collapse; margin-top: 15pt; }
                .table-services th { background-color: #D4EDDA; color: #333; padding: 8pt; border: 0.5pt solid #fff; text-align: center; font-size: 9pt; }
                .table-services td { padding: 8pt; border-bottom: 0.5pt solid #eee; vertical-align: top; }
                
                .table-pago { width: 100%; border-collapse: collapse; margin-top: 20pt; }
                .table-pago th.pago-header { background-color: #0070d2; color: white; padding: 5pt; text-align: center; font-weight: bold; border: 0.5pt solid #0070d2; }
                .table-pago th { background-color: #D4EDDA; color: #333; padding: 5pt; text-align: center; border: 0.5pt solid #fff; }
                .table-pago td { padding: 8pt; border: 0.5pt solid #eee; text-align: center; font-size: 9pt; }

                .totals-box { width: 300pt; float: right; margin-top: 10pt; }
                .total-row { display: table; width: 100%; padding: 3pt 0; }
                .total-label { display: table-cell; text-align: right; padding-right: 10pt; font-weight: bold; }
                .total-value { display: table-cell; text-align: right; width: 80pt; border-bottom: 0.5pt solid #eee; }
                .grand-total { font-size: 12pt; color: #0070d2; border-bottom: 2pt solid #0070d2; }

                .signature-section { margin-top: 50pt; width: 100%; }
                .sig-box { width: 33%; text-align: center; display: inline-block; vertical-align: bottom; }
                .sig-line { border-top: 1px solid #333; margin: 0 20pt; padding-top: 5pt; font-size: 9pt; }
            </style>
        </head>
        <body>
            <img src="/servlet/servlet.ImageServer?id=015V9000005wj9x&oid={!$Organization.Id}" class="header-img" />

            <div class="content-body">
                <div class="title-quote">PRESUPUESTO No. {!technicalQuote.QuoteNumber}</div>
                <div class="line-business">{!technicalQuote.Business_Lines_Selected__c}</div>

                <div style="margin-top: 5pt; font-size: 10pt;">
                    <div><strong>Número de Presupuesto:</strong> {!technicalQuote.QuoteNumber}</div>
                    <div><strong>Creado por:</strong> {!technicalQuote.CreatedBy.Name}</div>
                    <div><strong>Fecha:</strong> <apex:outputText value="{0,date,dd/MM/yyyy}"><apex:param value="{!technicalQuote.CreatedDate}" /></apex:outputText></div>
                </div>

                <div class="client-name" style="margin-top: 15pt;">{!technicalQuote.Technical_Sedes__c}</div>
                <div style="font-size: 11pt; margin-top: 5pt;"><strong>Asunto:</strong> {!technicalQuote.Name}</div>

                <!-- 1. INTRODUCCIÓN -->
                <apex:outputPanel rendered="{!technicalQuote.Show_Introduction__c}">
                    <div style="margin-top: 20pt; text-align: justify; display: block;">
                        <apex:outputText value="{!technicalQuote.Introduction_Text__c}" escape="false"/>
                    </div>
                </apex:outputPanel>

                <!-- 2. PRODUCTOS Y SERVICIOS -->
                <table class="table-services">
                    <thead>
                        <tr>
                            <th width="45%">CONCEPTO</th>
                            <th width="10%">CANT</th>
                            <th width="15%">P. UNITARIO</th>
                            <apex:variable var="anyDiscount" value="0" />
                            <apex:repeat value="{!technicalQuote.QuoteLineItems}" var="check">
                                <apex:variable var="anyDiscount" value="1" rendered="{!check.Discount > 0 || (check.ListPrice - check.UnitPrice) > 0}" />
                            </apex:repeat>
                            <apex:outputPanel rendered="{!anyDiscount == '1'}" layout="none">
                                <th width="10%">DESC.</th>
                            </apex:outputPanel>
                            <th width="20%">IMPORTE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <apex:repeat value="{!technicalQuote.QuoteLineItems}" var="item">
                            <tr>
                                <td><strong>{!item.Product2.Name}</strong></td>
                                <td align="center">{!item.Quantity}</td>
                                <td align="right">
                                    <apex:outputText value="{0, number, currency}">
                                        <apex:param value="{!item.ListPrice}" />
                                    </apex:outputText>
                                </td>
                                <apex:outputPanel rendered="{!anyDiscount == '1'}" layout="none">
                                    <td align="center" style="color: #d8000c; font-weight: bold;">
                                        <apex:outputPanel rendered="{!item.Discount != null && item.Discount > 0}">
                                            {!item.Discount}%
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!(item.Discount == null || item.Discount == 0) && (item.ListPrice > item.UnitPrice)}">
                                            <apex:outputText value="{0, number, currency}">
                                                <apex:param value="{!item.ListPrice - item.UnitPrice}" />
                                            </apex:outputText>
                                        </apex:outputPanel>
                                        <apex:outputPanel rendered="{!item.ListPrice == item.UnitPrice && (item.Discount == null || item.Discount == 0)}">
                                            -
                                        </apex:outputPanel>
                                    </td>
                                </apex:outputPanel>
                                <td align="right">
                                    <apex:outputText value="{0, number, currency}">
                                        <apex:param value="{!item.TotalPrice}" />
                                    </apex:outputText>
                                </td>
                            </tr>
                        </apex:repeat>
                    </tbody>
                </table>

                <!-- 2.1 DETALLE TÉCNICO DE SERVICIOS (FUERA DE TABLA) -->
                <div style="margin-top: 10pt;">
                    <apex:repeat value="{!technicalQuote.QuoteLineItems}" var="item">
                        <apex:outputPanel rendered="{!NOT(ISBLANK(item.Description))}">
                            <div style="margin-bottom: 8pt; border-bottom: 0.5pt solid #eee; padding-bottom: 4pt;">
                                <div style="font-weight: bold; color: #0070d2; font-size: 9pt;">Detalle: {!item.Product2.Name}</div>
                                <div style="font-size: 9pt; color: #333; margin-top: 2pt; text-align: justify;">
                                    <apex:outputText escape="false" value="{!item.Description}" />
                                </div>
                            </div>
                        </apex:outputPanel>
                    </apex:repeat>
                </div>

                <!-- 3. TOTALES -->
                <div class="totals-box">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 3pt 0; text-align: left; color: #666; font-size: 9pt;">SUBTOTAL</td>
                            <td style="padding: 3pt 0; text-align: right; font-weight: bold; width: 80pt;">
                                <apex:outputText value="{0, number, currency}">
                                    <apex:param value="{!technicalQuote.Subtotal}" />
                                </apex:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 3pt 0; text-align: left; color: #d8000c; font-size: 9pt;">DESCUENTO</td>
                            <td style="padding: 3pt 0; text-align: right; font-weight: bold; color: #d8000c;">
                                - <apex:outputText value="{0, number, currency}">
                                    <apex:param value="{!IF(ISNULL(technicalQuote.Discount), 0, technicalQuote.Discount)}" />
                                </apex:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 3pt 0; text-align: left; color: #666; font-size: 9pt;">I.V.A. (16%)</td>
                            <td style="padding: 3pt 0; text-align: right; font-weight: bold;">
                                <apex:outputText value="{0, number, currency}">
                                    <apex:param value="{!technicalQuote.Tax}" />
                                </apex:outputText>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8pt 0; text-align: left; font-size: 12pt; font-weight: bold; color: #0070d2;">TOTAL</td>
                            <td style="padding: 8pt 0; text-align: right; font-size: 12pt; font-weight: bold; color: #0070d2; border-bottom: 2pt solid #0070d2;">
                                <apex:outputText value="{0, number, currency}">
                                    <apex:param value="{!technicalQuote.TotalPrice}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </table>
                </div>

                <div style="clear: both;"></div>

                <!-- 4. DATOS DE PAGO -->
                <div style="background-color: #0070d2; color: white; padding: 4pt; text-align: center; font-weight: bold; font-size: 10pt; margin-top: 20pt; border: 0.5pt solid #0070d2;">DATOS DE PAGO</div>
                <table class="table-pago" style="margin-top: 0;">
                    <thead>
                        <tr>
                            <th style="background-color: #D4EDDA; color: #333; width: 25%;">Método de pago</th>
                            <th style="background-color: #D4EDDA; color: #333; width: 50%;">OBSERVACIONES SOBRE PAGOS</th>
                            <th style="background-color: #D4EDDA; color: #333; width: 25%;">TIPO DE TRABAJO A REALIZAR</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="text-align: center; vertical-align: middle;">
                                <apex:outputText value="Transferencia" rendered="{!technicalQuote.Phone == 'true'}" /> <!-- Usando campos temporales si no existen los booleanos en Quote -->
                                <apex:outputText value=" / " rendered="{!technicalQuote.Phone == 'true' && technicalQuote.Email == 'true'}" />
                                <apex:outputText value="Tarjeta" rendered="{!technicalQuote.Email == 'true'}" />
                                <apex:outputText value="Transferencia / Tarjeta" rendered="{!technicalQuote.Phone != 'true' && technicalQuote.Email != 'true'}" />
                            </td>
                            <td style="text-align: left; vertical-align: top;">
                                <apex:outputText value="{!technicalQuote.Description}" escape="false" />
                            </td>
                            <td style="text-align: center; vertical-align: middle;">
                                Servicio Técnico
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- 5. CONDICIONES / ANEXOS / CLAUSULAS -->
                <apex:outputPanel rendered="{!technicalQuote.Show_Warranty__c}">
                    <div style="margin-top: 30pt; border-top: 1pt solid #ccc; padding-top: 10pt;">
                        <div style="font-weight: bold; font-size: 11pt; margin-bottom: 8pt; text-transform: uppercase; color: #000;">Condiciones / Anexos / Cláusulas</div>
                        <div style="font-size: 9pt; text-align: justify; line-height: 1.4;">
                            <apex:outputText escape="false" value="{!technicalQuote.Warranty_Text__c}" />
                        </div>
                    </div>
                </apex:outputPanel>

                <!-- SECCIÓN DE FIRMAS -->
                <div class="signature-section">
                    <div class="sig-box">
                        <div class="sig-line">Firma del CLIENTE</div>
                    </div>
                    <div class="sig-box">
                        <div style="margin-bottom: 10pt;">
                            <div style="font-family: cursive; font-size: 16pt;">{!technicalQuote.CreatedBy.Name}</div>
                        </div>
                        <div class="sig-line">
                            Firma de {!technicalQuote.CreatedBy.Name}<br/>
                            E-MAIL: {!technicalQuote.CreatedBy.Email}
                        </div>
                    </div>
                    <div class="sig-box">
                        <div style="border: 1px solid #ccc; width: 60pt; height: 60pt; margin: 0 auto 5pt auto; border-radius: 50%; font-size: 8pt; line-height: 60pt;">SELLO</div>
                        <div class="sig-line">Sello de la empresa</div>
                    </div>
                </div>
            </div> <!-- Cierre de content-body -->

            <img src="/servlet/servlet.ImageServer?id=015V9000005wjDB&oid={!$Organization.Id}" class="footer-img" />
        </body>
    </html>
</apex:page>