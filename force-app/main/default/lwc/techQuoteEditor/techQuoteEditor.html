<template>
    <div class="main-container">
        <!-- HEADER CON PROGRESO -->
        <div class="progress-container">
            <lightning-progress-indicator current-step={currentStep} type="path" variant="base">
                <lightning-progress-step label="Contrato" value="1"></lightning-progress-step>
                <lightning-progress-step label="Datos Técnicos" value="2"></lightning-progress-step>
                <lightning-progress-step label="Detalles" value="3"></lightning-progress-step>
                <lightning-progress-step label="Finalizar" value="4"></lightning-progress-step>
            </lightning-progress-indicator>
        </div>

        <div class="slds-p-around_large content-area">
            
            <!-- PASO 1: ORIGEN Y ESTRATEGIA -->
            <template if:true={isStep1}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <h2 class="slds-text-heading_small">Estrategia de Venta</h2>
                        </div>
                    </div>
                    <div class="slds-p-around_large">
                        <lightning-radio-group name="estrategiaVenta"
                            label="Categoría"
                            options={estrategiaOptions}
                            value={estrategiaVenta}
                            onchange={handleEstrategiaChange}
                            type="button"
                            variant="label-hidden"
                            class="custom-radio-group">
                        </lightning-radio-group>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <h2 class="slds-text-heading_small">Origen: Necesidad o Levantamiento</h2>
                        </div>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters slds-grid_vertical-align-end">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3" style="position: relative;">
                                <lightning-input type="search" label="Buscar Necesidad / Levantamiento relacionado" 
                                    placeholder="Escriba el nombre o folio..."
                                    onchange={handleNecesidadChange}
                                    value={necesidadSeleccionada}>
                                </lightning-input>
                                <template if:true={necesidadesResults.length}>
                                    <div class="slds-dropdown slds-dropdown_fluid slds-p-around_xx-small" style="position: absolute; display: block; z-index: 9999;">
                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                            <template for:each={necesidadesResults} for:item="n">
                                                <li key={n.id} role="presentation" class="slds-listbox__item" onclick={handleNecesidadSelect} data-id={n.id}>
                                                    <div class="slds-media slds-listbox__option slds-listbox__option_plain" role="option">
                                                        <span class="slds-media__body">
                                                            <span class="slds-truncate" title={n.name}>{n.name}</span>
                                                        </span>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                <lightning-button label="Nuevo Levantamiento" icon-name="utility:table" variant={levantamientoBtnVariant} class="slds-size_1-of-1" onclick={toggleSurveyTable}></lightning-button>
                            </div>
                        </div>

                        <!-- MOTOR DE PLANTILLAS DE LEVANTAMIENTO (INYECTADO) -->
                        <template if:true={showSurveyTable}>
                            <div class="slds-m-top_large border-top slds-p-top_medium">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <div class="slds-size_1-of-3">
                                        <lightning-combobox label="Tipo de Levantamiento" value={surveyType} options={surveyTypeOptions} onchange={handleSurveyTypeChange}></lightning-combobox>
                                    </div>
                                    <lightning-button label="Agregar Fila" icon-name="utility:add" variant="brand-outline" size="small" onclick={handleAddSurveyRow}></lightning-button>
                                </div>

                                <!-- PLANTILLA 1: BIOENZIMATICO -->
                                <template if:true={isBio}>
                                    <div class="table-scroll-container survey-scroll-wrapper"><table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 2600px;"><thead><tr class="survey-header-group"><th colspan="4"></th><th colspan="2">EQUIPO</th><th colspan="3">TAMAÑO BIDÓN</th><th colspan="3">UBICACIÓN DE BIDÓN</th><th colspan="1"></th><th colspan="5">PRÁCTICAS DE OPERACIÓN</th><th colspan="8">INSTALACIONES</th><th colspan="1"></th></tr><tr class="slds-line-height_reset"><th style="width: 45px;">#</th><th style="width: 110px;">NIVEL</th><th style="width: 180px;">ÁREA (COCINA/BAÑOS)</th><th style="width: 160px;">ZONA / GÉNERO</th><th style="width: 80px;"># VE</th><th style="width: 80px;"># VP</th><th style="width: 80px;">#10L</th><th style="width: 80px;">#20L</th><th style="width: 80px;">#25L</th><th style="width: 80px;"># PISO</th><th style="width: 80px;"># MUEB.</th><th style="width: 80px;"># PARED</th><th style="width: 110px;">FOTO</th><th style="width: 150px;">RESIDUOS TARJA</th><th style="width: 150px;">ESCAMOCHE</th><th style="width: 150px;">INSTALACIONES</th><th style="width: 130px;">AZOLVES</th><th style="width: 220px;">OBSERVACIÓN</th><th style="width: 90px;">COLAD.</th><th style="width: 90px;">TAPÓN REG.</th><th style="width: 80px;">TARJA</th><th style="width: 90px;"># TINAS x T.</th><th style="width: 90px;">T. GRASA</th><th style="width: 130px;">MODELO TG</th><th style="width: 80px;">ST-1</th><th style="width: 100px;">OVALINES</th><th style="width: 50px;"></th></tr></thead><tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td>{row.rowNumber}</td><td><input type="text" class="cell-input" data-index={index} data-field="nivel" value={row.nivel} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="area" value={row.area} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="zona" value={row.zona} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="ve" value={row.ve} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="vp" value={row.vp} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="c10l" value={row.c10l} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="c20l" value={row.c20l} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="c25l" value={row.c25l} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="piso" value={row.piso} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="mueble" value={row.mueble} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="pared" value={row.pared} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="foto" value={row.foto} onchange={handleSurveyChange}></td><td><select class="cell-select" data-index={index} data-field="residuos" onchange={handleSurveyChange}><option value="">-</option><option value="Sin residuos (Correcto)" selected={row.isResiduoNo}>No</option><option value="Presencia de residuos sólidos" selected={row.isResiduoSi}>Sí</option></select></td><td><select class={row.escamocheClass} data-index={index} data-field="escamoche" onchange={handleSurveyChange}><option value="">-</option><option value="Correcto, separan orgánico e inorgánico" selected={row.isEscamocheOk}>Correcto</option><option value="Lo hacen a medias, basura en suelo, botes con basura revuelta" selected={row.isEscamocheMid}>A medias</option><option value="Pésimo, tarjas, pisos y coladeras con basura; no hay cuidado" selected={row.isEscamocheBad}>Pésimo</option></select></td><td><select class="cell-select" data-index={index} data-field="instala" onchange={handleSurveyChange}><option value="">-</option><option value="Bien" selected={row.isInstalaBien}>Bien</option><option value="Regular" selected={row.isInstalaRegular}>Regular</option><option value="Mal" selected={row.isInstalaMal}>Mal</option></select></td><td><select class="cell-select" data-index={index} data-field="azolves" onchange={handleSurveyChange}><option value="NA" selected={row.isAzolveNA}>NA</option><option value="1 año" selected={row.isAzolve1A}>1 año</option><option value="1 mes" selected={row.isAzolve1M}>1 mes</option><option value="2 quin" selected={row.isAzolve2Q}>2 quin</option><option value="1 sem" selected={row.isAzolve1S}>1 sem</option></select></td><td><input type="text" class="cell-input" data-index={index} data-field="obs" value={row.obs} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="coladeras" value={row.coladeras} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tapon" value={row.tapon} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tarja" value={row.tarja} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tinas" value={row.tinas} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tgrasa" value={row.tgrasa} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="modelo" value={row.modelo} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="st1" value={row.st1} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="ovalines" value={row.ovalines} onchange={handleSurveyChange}></td><td class="slds-text-align_center"><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.ve}</td><td>{surveyTotals.vp}</td><td>{surveyTotals.c10l}</td><td>{surveyTotals.c20l}</td><td>{surveyTotals.c25l}</td><td>{surveyTotals.piso}</td><td>{surveyTotals.mueble}</td><td>{surveyTotals.pared}</td><td colspan="6" class="total-empty-cell"></td><td>{surveyTotals.coladeras}</td><td>{surveyTotals.tapon}</td><td>{surveyTotals.tarja}</td><td>{surveyTotals.tinas}</td><td>{surveyTotals.tgrasa}</td><td>-</td><td>{surveyTotals.st1}</td><td>{surveyTotals.ovalines}</td><td></td></tr></tbody></table></div>
                                </template>

                                <!-- PLANTILLA 2: GRASAS -->
                                <template if:true={isGrasas}>
                                    <div class="table-scroll-container survey-scroll-wrapper"><table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 1800px;"><thead><tr class="survey-header-group"><th colspan="4"></th><th colspan="5">T. GRASA (TG)</th><th colspan="5">REFACCIONES</th><th colspan="1"></th></tr><tr class="slds-line-height_reset"><th style="width: 40px;">#</th><th style="width: 100px;">NIVEL</th><th style="width: 160px;">ÁREA</th><th style="width: 140px;">ZONA</th><th style="width: 70px;">SP</th><th style="width: 70px;">ENT</th><th style="width: 140px;">MODELO</th><th style="width: 140px;">FRECUENCIA</th><th style="width: 140px;">ESTADO</th><th style="width: 80px;">TORNILLO</th><th style="width: 80px;">SELLO</th><th style="width: 80px;">MAMPARA</th><th style="width: 80px;">CANAST..</th><th style="width: 80px;">RET. SAL.</th><th style="width: 100px;">FOTO</th><th style="width: 45px;"></th></tr></thead><tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td>{row.rowNumber}</td><td><input type="text" class="cell-input" data-index={index} data-field="nivel" value={row.nivel} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="area" value={row.area} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="zona" value={row.zona} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="sp" value={row.sp} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="ent" value={row.ent} onchange={handleSurveyChange}></td><td><select class="cell-select" data-index={index} data-field="modelo" onchange={handleSurveyChange}><option value="">-</option><option value="IG-20" selected={row.isModIG20}>IG-20</option><option value="IG-40" selected={row.isModIG40}>IG-40</option><option value="CORIAT" selected={row.isModCoriat}>CORIAT</option><option value="INTERNATIONAL" selected={row.isModInter}>INTERNATIONAL</option><option value="OTRO" selected={row.isModOtro}>OTRO</option></select></td><td><select class="cell-select" data-index={index} data-field="frecuencia" onchange={handleSurveyChange}><option value="">-</option><option value="1 VEZ A LA SEMANA" selected={row.isFreqSemana}>1 VEZ A LA SEMANA</option><option value="1 VEZ A LA QUINCENA" selected={row.isFreqQuincena}>1 VEZ A LA QUINCENA</option><option value="1 VEZ AL MES" selected={row.isFreqMes}>1 VEZ AL MES</option></select></td><td><select class={row.estadoClass} data-index={index} data-field="estado" onchange={handleSurveyChange}><option value="">-</option><option value="EN BUEN ESTADO" selected={row.isEstBuen}>EN BUEN ESTADO</option><option value="EN MAL ESTADO" selected={row.isEstMal}>EN MAL ESTADO</option><option value="EN PESIMO ESTADO" selected={row.isEstPesimo}>EN PESIMO ESTADO</option></select></td><td><input type="number" class="cell-input" data-index={index} data-field="tornillo" value={row.tornillo} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="sello" value={row.sello} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="mampara" value={row.mampara} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="canastilla" value={row.canastilla} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="retSalida" value={row.retSalida} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="foto" value={row.foto} onchange={handleSurveyChange}></td><td><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.sp}</td><td>{surveyTotals.ent}</td><td colspan="3" class="total-empty-cell"></td><td>{surveyTotals.tornillo}</td><td>{surveyTotals.sello}</td><td>{surveyTotals.mampara}</td><td>{surveyTotals.canastilla}</td><td>{surveyTotals.retSalida}</td><td></td><td></td></tr></tbody></table></div>
                                </template>

                                <!-- PLANTILLA 3: INTIMA (DIAGNÓSTICO VERTICAL + CENSO) -->
                                <template if:true={isIntima}>
                                    <div class="slds-grid slds-wrap slds-gutters">
                                        <div class="slds-col slds-size_1-of-1 slds-large-size_5-of-12">
                                            <h4 class="slds-text-title_bold text-diagnostico slds-m-bottom_x-small">Diagnóstico Situacional</h4>
                                            <div class="diag-vertical-container">
                                                <table class="survey-table vertical-diag-table slds-table slds-table_bordered">
                                                    <tbody>
                                                        <tr><td class="diag-label">Número de usuarias internas (colaboradoras)</td><td><input type="number" class="cell-input" value={gmUsuariasInt} data-field="gmUsuariasInt" onchange={handleGmChange} placeholder="# personas menstruantes"></td></tr>
                                                        <tr><td class="diag-label">Número de usuarias externas (clientes/proveedores)</td><td><input type="number" class="cell-input" value={gmUsuariasExt} data-field="gmUsuariasExt" onchange={handleGmChange} placeholder="# personas menstruantes"></td></tr>
                                                        <tr><td class="diag-label">Frecuencia de uso de las usuarias</td><td><select class="cell-select" data-field="gmFreqUso" onchange={handleGmChange}><option value="">-</option><option value="Lunes a viernes" selected={isGmFreqLV}>Lunes a viernes</option><option value="Días alternados (ej. home office)" selected={isGmFreqAlt}>Días alternados (ej. home office)</option></select></td></tr>
                                                        <tr><td class="diag-label">Número de sanitarios</td><td><input type="number" class="cell-input" value={gmSanitarios} data-field="gmSanitarios" onchange={handleGmChange} placeholder="# cuarto"></td></tr>
                                                        <tr><td class="diag-label">Número de cubículos (con WC por sanitario)</td><td><input type="number" class="cell-input" value={gmCubiculos} data-field="gmCubiculos" onchange={handleGmChange} placeholder="# cubículo"></td></tr>
                                                        <tr><td class="diag-label">Número de contenedores instalados</td><td><input type="number" class="cell-input" value={gmContenedores} data-field="gmContenedores" onchange={handleGmChange} placeholder="-"></td></tr>
                                                        <tr><td class="diag-label">Frecuencia de recolección</td><td><select class="cell-select" data-field="gmFreqRecoleccion" onchange={handleGmChange}><option value="">-</option><option value="7 días" selected={isGmRec7}>7 días</option><option value="14 días" selected={isGmRec14}>14 días</option><option value="21 días" selected={isGmRec21}>21 días</option><option value="28 días" selected={isGmRec28}>28 días</option><option value="Otro:" selected={isGmRecOtro}>Otro:</option></select></td></tr>
                                                        <tr><td class="diag-label">Días servicio requerido</td><td><select class="cell-select" data-field="gmDiasServicio" onchange={handleGmChange}><option value="">-</option><option value="Lunes a Viernes" selected={isGmDiasLV}>Lunes a Viernes</option><option value="Sábado o domingo" selected={isGmDiasFin}>Sábado o domingo</option></select></td></tr>
                                                        <tr><td class="diag-label">Horario regular del servicio</td><td><input type="text" class="cell-input" value={gmHorario} data-field="gmHorario" onchange={handleGmChange} placeholder="00:00 hrs"></td></tr>
                                                        <tr><td class="diag-label">Requiere permisos acceso</td><td><select class="cell-select" data-field="gmPermisos" onchange={handleGmChange}><option value="">-</option><option value="Si" selected={isGmPermSi}>Si</option><option value="No" selected={isGmPermNo}>No</option></select></td></tr>
                                                        <tr><td class="diag-label">Consideraciones acceso</td><td><input type="text" class="cell-input" value={gmConsideraciones} data-field="gmConsideraciones" onchange={handleGmChange} placeholder="NA o Describir"></td></tr>
                                                        <tr><td class="diag-label">Disponibilidad capacitación</td><td><select class="cell-select" data-field="gmCapacitacion" onchange={handleGmChange}><option value="">-</option><option value="Si" selected={isGmCapSi}>Si</option><option value="No" selected={isGmCapNo}>No</option></select></td></tr>
                                                        <tr><td class="diag-label">Presupuesto asignado RM</td><td><input type="text" class="cell-input" value={gmPresupuesto} data-field="gmPresupuesto" onchange={handleGmChange} placeholder="Ppto/Prov?"></td></tr>
                                                        <tr><td class="diag-label">Nos buscan porque busca…</td><td><select class="cell-select" data-field="gmMotivo" onchange={handleGmChange}><option value="">-</option><option value="Mejorar sus prácticas en el manejo de residuo" selected={isGmMot1}>Mejorar prácticas</option><option value="Evitar azolves porque arrojan los RGM al WC" selected={isGmMot2}>Evitar azolves</option><option value="Otro" selected={isGmMot7}>Otro</option></select></td></tr>
                                                        <tr><td class="diag-label">Cliente permite levantamiento</td><td><select class="cell-select" data-field="gmPermiteLev" onchange={handleGmChange}><option value="">-</option><option value="Si" selected={isGmLevSi}>Si</option><option value="No" selected={isGmLevNo}>No</option></select></td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="slds-col slds-size_1-of-1 slds-large-size_7-of-12">
                                            <h4 class="slds-text-title_bold slds-m-bottom_x-small" style="color: #1e293b !important;">Censo de Cubículos</h4>
                                            <div class="table-scroll-container survey-scroll-wrapper" style="max-height: 605px;">
                                                <table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 100%;">
                                                    <thead><tr class="slds-line-height_reset"><th style="width: 40px;">#</th><th style="width: 100px;">NIVEL</th><th style="width: 180px;">ÁREA</th><th style="width: 160px;">ZONA</th><th style="width: 100px;"># WC</th><th style="width: 180px;">FRECUENCIA</th><th style="width: 180px;">DÍAS SERVICIO</th><th style="width: 45px;"></th></tr></thead>
                                                    <tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td class="slds-text-align_center">{row.rowNumber}</td><td><input type="text" class="cell-input" data-index={index} data-field="nivel" value={row.nivel} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="area" value={row.area} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="zona" value={row.zona} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="wc" value={row.wc} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="frecuencia" value={row.frecuencia} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="dias" value={row.dias} onchange={handleSurveyChange}></td><td><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.wc}</td><td colspan="3" class="total-empty-cell"></td></tr></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- PLANTILLA 4: DESAZOLVE MECANICO -->
                                <template if:true={isDesazolveMec}>
                                    <div class="table-scroll-container survey-scroll-wrapper"><table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 1600px;"><thead><tr class="survey-header-group"><th colspan="4"></th><th colspan="5">SANITARIOS</th><th colspan="3"></th></tr><tr class="slds-line-height_reset"><th style="width: 40px;">#</th><th style="width: 100px;">NIVEL</th><th style="width: 160px;">ÁREA</th><th style="width: 140px;">ZONA</th><th style="width: 90px;">OVALINES</th><th style="width: 90px;">COLAD.</th><th style="width: 90px;">TAPÓN</th><th style="width: 90px;">MINGIT.</th><th style="width: 90px;">WC</th><th style="width: 110px;">MT LÍNEAL</th><th style="width: 110px;">TARJAS</th><th style="width: 130px;">CTO. HÚMEDO</th><th style="width: 45px;"></th></tr></thead><tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td>{row.rowNumber}</td><td><input type="text" class="cell-input" data-index={index} data-field="nivel" value={row.nivel} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="area" value={row.area} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="zona" value={row.zona} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="ovalines" value={row.ovalines} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="coladeras" value={row.coladeras} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tapon" value={row.tapon} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="mingitorios" value={row.mingitorios} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="wc" value={row.wc} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="mtLineal" value={row.mtLineal} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="tarjas" value={row.tarjas} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="cuartoHumado" value={row.cuartoHumado} onchange={handleSurveyChange}></td><td><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.ovalines}</td><td>{surveyTotals.coladeras}</td><td>{surveyTotals.tapon}</td><td>{surveyTotals.mingitorios}</td><td>{surveyTotals.wc}</td><td>{surveyTotals.mtLineal}</td><td>{surveyTotals.tarjas}</td><td>{surveyTotals.cuartoHumado}</td><td></td></tr></tbody></table></div>
                                </template>

                                <!-- PLANTILLA 5: AROMATIZANTES -->
                                <template if:true={isAromatizantes}>
                                    <div class="table-scroll-container survey-scroll-wrapper"><table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 100%;"><thead><tr class="slds-line-height_reset"><th style="width: 40px;">#</th><th style="width: 100px;">NIVEL</th><th style="width: 200px;">ÁREA</th><th style="width: 180px;">ZONA</th><th style="width: 120px;"># ARM</th><th style="width: 45px;"></th></tr></thead><tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td>{row.rowNumber}</td><td><input type="text" class="cell-input" data-index={index} data-field="nivel" value={row.nivel} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="area" value={row.area} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="zona" value={row.zona} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="arm" value={row.arm} onchange={handleSurveyChange}></td><td><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.arm}</td><td></td></tr></tbody></table></div>
                                </template>

                                <!-- PLANTILLA 6: VACTOR -->
                                <template if:true={isVactor}>
                                    <div class="table-scroll-container survey-scroll-wrapper"><table class="survey-table slds-table slds-table_bordered slds-table_fixed-layout" style="width: 2400px;"><thead><tr class="slds-line-height_reset"><th style="width: 150px;">DESCRIPCIÓN</th><th style="width: 80px;">MEDIDA</th><th style="width: 120px;">MATERIAL</th><th style="width: 120px;">SRV REQUERIDO</th><th style="width: 60px;">LARGO</th><th style="width: 60px;">ANCHO</th><th style="width: 60px;">PROF.</th><th style="width: 80px;">MT LÍNEA</th><th style="width: 180px;">DISTANCIA</th><th style="width: 120px;">PERM. DELEG</th><th style="width: 120px;">PERM. PLAZA</th><th style="width: 100px;">DIFICULTAD</th><th style="width: 180px;">ALCANCE</th><th style="width: 150px;">OBS</th><th style="width: 35px;"></th></tr></thead><tbody><template for:each={surveyData} for:item="row" for:index="index"><tr key={row.id}><td><select class="cell-select" data-index={index} data-field="desc" onchange={handleSurveyChange}><option value="">-</option><option value="Cárcamo" selected={row.isCarcamo}>Cárcamo</option><option value="Registro" selected={row.isRegistro}>Registro</option><option value="Tub. elevada Horizontal" selected={row.isTubH}>Tub. elevada Horiz.</option></select></td><td><select class="cell-select" data-index={index} data-field="medida" onchange={handleSurveyChange}><option value="">-</option><option value='1"' selected={row.isM1}>1"</option><option value='4"' selected={row.isM4}>4"</option></select></td><td><input type="text" class="cell-input" data-index={index} data-field="material" value={row.material} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="servicio" value={row.servicio} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="largo" value={row.largo} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="ancho" value={row.ancho} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="prof" value={row.prof} onchange={handleSurveyChange}></td><td><input type="number" class="cell-input" data-index={index} data-field="mtLineal" value={row.mtLineal} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="distancia" value={row.distancia} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="permDelegacion" value={row.permDelegacion} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="permPlaza" value={row.permPlaza} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="dificultad" value={row.dificultad} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="alcance" value={row.alcance} onchange={handleSurveyChange}></td><td><input type="text" class="cell-input" data-index={index} data-field="obs" value={row.obs} onchange={handleSurveyChange}></td><td><lightning-button-icon icon-name="utility:delete" variant="error" size="xx-small" data-index={index} onclick={handleRemoveSurveyRow}></lightning-button-icon></td></tr></template><tr class="survey-row-totals"><td colspan="4" class="total-label-cell">TOTAL</td><td>{surveyTotals.largo}</td><td>{surveyTotals.ancho}</td><td>{surveyTotals.prof}</td><td>{surveyTotals.mtLinealVactor}</td><td colspan="7" class="total-empty-cell"></td></tr></tbody></table></div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>
            </template>

            <!-- PASO 2: DATOS TÉCNICOS -->
            <template if:true={isStep2}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <lightning-icon icon-name="utility:info" size="small" class="slds-m-right_small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Información del Presupuesto</h2>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <lightning-input type="text" label="Número de Presupuesto" value={folio} readonly></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <lightning-input type="text" label="Asunto" value={asunto} onchange={handleAsuntoChange}></lightning-input>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header slds-grid slds-grid_align-spread">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <lightning-icon icon-name="utility:announcement" size="small" class="slds-m-right_small"></lightning-icon>
                            <h2 class="slds-text-heading_small">Introducción</h2>
                        </div>
                        <lightning-button-menu label="Cargar Plantilla" icon-name="utility:insert_tag_field" variant="border-filled" onselect={handleApplyTemplate} data-field="introduccion">
                            <template for:each={introTemplates} for:item="tpl">
                                <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                            </template>
                        </lightning-button-menu>
                    </div>
                    <div class="slds-p-around_large">
                        <lightning-input-rich-text value={introduccion} onchange={handleIntroChange} variant="bottom-toolbar"></lightning-input-rich-text>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <lightning-icon icon-name="utility:tower" size="small" class="slds-m-right_small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Línea de Negocio</h2>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap">
                            <template for:each={lineaNegocioOptions} for:item="option">
                                <div key={option.value} class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-around_xx-small">
                                    <div class="custom-checkbox-card">
                                        <lightning-input type="checkbox" label={option.label} data-value={option.value} checked={option.checked} onchange={handleLineChange}></lightning-input>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header slds-grid slds-grid_align-spread">
                        <h2 class="slds-text-heading_small">Seleccionar Sedes</h2>
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <span class="slds-m-right_small slds-text-title_bold" style="color: #0070d2;">{sedeScopeLabel}</span>
                            <lightning-input type="toggle" label="Búsqueda Global" variant="label-hidden" 
                                checked={isGlobalSedeSearch} onchange={handleSedeScopeChange}
                                message-toggle-active="Directa" message-toggle-inactive="Jerarquía">
                            </lightning-input>
                        </div>
                    </div>

                    <!-- BUSCADOR DE CUENTA PADRE (Solo si no es búsqueda directa) -->
                    <template if:false={isGlobalSedeSearch}>
                        <div class="slds-p-around_medium border-bottom bg-blue-soft" style="position: relative;">
                            <p class="slds-text-title_bold slds-m-bottom_x-small">1. Buscar Cuenta Padre / Corporativo</p>
                            <lightning-input type="search" placeholder="Escribe el nombre del cliente (ej. Liverpool)..." 
                                variant="label-hidden" value={parentSearchTerm} onchange={handleParentSearch}>
                            </lightning-input>
                            
                            <template if:true={selectedParentName}>
                                <div class="slds-m-top_x-small">
                                    <lightning-pill label={selectedParentName} icon-name="standard:account" onremove={handleRemoveParent}></lightning-pill>
                                </div>
                            </template>

                            <template if:true={parentSearchResults.length}>
                                <div class="product-search-results" style="top: 75px;">
                                    <ul class="slds-listbox slds-listbox_vertical">
                                        <template for:each={parentSearchResults} for:item="p">
                                            <li key={p.id} class="slds-listbox__item" onclick={handleParentSelect} data-id={p.id} data-name={p.name}>
                                                <div class="slds-media slds-listbox__option_entity">
                                                    <span class="product-name">{p.name}</span>
                                                </div>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </template>

                    <div class="slds-p-around_medium border-bottom bg-light-gray">
                        <p class="slds-text-title_bold slds-m-bottom_x-small">
                            {sedeSearchPlaceholder}
                        </p>
                        <lightning-input type="search" placeholder="Escribe el nombre de la sede..." 
                            variant="label-hidden" value={sedeSearchTerm} onchange={handleSedeSearch}>
                        </lightning-input>
                    </div>

                    <div class="datatable-container scrollable-table">
                        <lightning-datatable key-field="Id" data={sedesData} columns={sedesColumns} selected-rows={selectedSedesIds} onrowselection={handleSedeSelection} max-row-selection={maxRowSelection}></lightning-datatable>
                    </div>
                </div>
            </template>

            <!-- PASO 3: DETALLES -->
            <template if:true={isStep3}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <h2 class="slds-text-heading_small">Servicios/Artículos (Arrastre para reordenar)</h2>
                    </div>
                    <div class="slds-p-around_none datatable-container">
                        <table class="custom-drag-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th> <!-- Icono de arrastre -->
                                    <th>Descripción</th>
                                    <th>Sedes</th>
                                    <th style="width: 80px; text-align: center;">Cant.</th>
                                    <th style="width: 120px; text-align: right;">Total (Sin IVA)</th>
                                    <th style="width: 100px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody ondragover={handleDragOver} ondrop={handleDrop}>
                                <template for:each={serviciosData} for:item="item" for:index="index">
                                    <!-- FILA DE SEPARADOR (Ancho Completo) -->
                                    <template if:true={item.isSeparator}>
                                        <tr key={item.id} 
                                            class="row-separator" 
                                            draggable="true" 
                                            ondragstart={handleDragStart} 
                                            data-index={index}>
                                            <td class="drag-handle"><lightning-icon icon-name="utility:rows" size="xx-small"></lightning-icon></td>
                                            <td colspan="4" class="separator-text-cell">
                                                <div class="separator-bar">
                                                    <span>{item.descripcion}</span>
                                                </div>
                                            </td>
                                            <td class="slds-text-align_center">
                                                <lightning-button-icon icon-name="utility:delete" variant="error" size="small" onclick={handleRowAction} data-id={item.id} data-action="delete"></lightning-button-icon>
                                            </td>
                                        </tr>
                                    </template>

                                    <!-- FILA DE SERVICIO ESTÁNDAR -->
                                    <template if:false={item.isSeparator}>
                                        <tr key={item.id} 
                                            class="row-service" 
                                            draggable="true" 
                                            ondragstart={handleDragStart} 
                                            data-index={index}>
                                            <td class="drag-handle"><lightning-icon icon-name="utility:rows" size="xx-small"></lightning-icon></td>
                                            <td class="font-bold">{item.descripcion}</td>
                                            <td><div class="slds-truncate" title={item.sedes}>{item.sedes}</div></td>
                                            <td class="slds-text-align_center">{item.cantidad}</td>
                                            <td class="slds-text-align_right">
                                                <lightning-formatted-number value={item.totalSinImpuestos} format-style="currency"></lightning-formatted-number>
                                            </td>
                                            <td class="slds-text-align_center">
                                                <lightning-button-icon icon-name="utility:delete" variant="border-filled" size="small" onclick={handleRowAction} data-id={item.id} data-action="delete"></lightning-button-icon>
                                            </td>
                                        </tr>
                                    </template>
                                </template>
                            </tbody>
                        </table>

                        <div class="slds-p-around_medium slds-grid slds-grid_align-spread bg-white border-bottom">
                            <div class="slds-grid">
                                <lightning-button label="+ Añadir servicios" variant="success" class="btn-verde slds-m-right_small" onclick={handleOpenModal}></lightning-button>
                                <lightning-button label="+ Añadir Separador" variant="success" class="btn-verde" onclick={handleOpenSeparatorModal}></lightning-button>
                            </div>
                            <lightning-button label="P&L" icon-name="utility:calculator" class="btn-azul-pastel" onclick={handleOpenPLModal}></lightning-button>
                        </div>
                    </div>

                    <!-- RESTAURACIÓN: RESUMEN DE TOTALES Y CONFIGURACIÓN PDF -->
                    <div class="totales-title-area slds-p-around_medium bg-white">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <h3 class="slds-text-title_bold">Resumen de Totales</h3>
                        </div>
                    </div>
                    <div class="slds-p-around_none datatable-container">
                        <lightning-datatable key-field="id" data={totalesData} columns={totalesColumns} hide-checkbox-column></lightning-datatable>
                    </div>
                    <div class="slds-p-around_large bg-white border-top">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-3">
                                <div class="custom-checkbox-card">
                                    <lightning-input type="checkbox" label="Mostrar el importe total del presupuesto" 
                                        checked={showTotal} onchange={handleShowTotalChange}>
                                    </lightning-input>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-3">
                                <div class="custom-checkbox-card">
                                    <lightning-input type="checkbox" label="Mostrar los impuestos en el pdf" 
                                        checked={showTaxes} onchange={handleShowTaxesChange}>
                                    </lightning-input>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-3">
                                <div class="custom-checkbox-card">
                                    <lightning-input type="checkbox" label="Mostrar el importe en las líneas" 
                                        checked={showLineItems} onchange={handleShowLineItemsChange}>
                                    </lightning-input>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="slds-p-around_medium">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <lightning-input type="checkbox" label="Añadir descripción / explicación" checked={showDescription} onchange={handleShowDescriptionChange}></lightning-input>
                        </div>
                        <template if:true={showDescription}>
                            <div class="slds-m-top_medium slds-p-around_small border-all radius-8 bg-light-gray">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <p class="slds-text-title_bold">Condiciones / Anexos / Cláusulas:</p>
                                    <lightning-button-menu label="Usar Plantilla" icon-name="utility:copy" variant="bare" onselect={handleApplyTemplate} data-field="warranty">
                                        <template for:each={warrantyTemplates} for:item="tpl">
                                            <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                        </template>
                                    </lightning-button-menu>
                                </div>
                                <lightning-input-rich-text value={warranty} onchange={handleWarrantyChange} variant="bottom-toolbar"></lightning-input-rich-text>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header"><h2 class="slds-text-heading_small">Método de Pago</h2></div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <p class="slds-text-title_bold">Opciones de Pago</p>
                                <lightning-input type="checkbox" label="Transferencia" checked={pagoTransferencia} onchange={handlePagoTransferenciaChange}></lightning-input>
                                <lightning-input type="checkbox" label="Tarjeta" checked={pagoTarjeta} onchange={handlePagoTarjetaChange}></lightning-input>
                                
                                <p class="slds-text-title_bold slds-m-top_medium">TIPO DE TRABAJO:</p>
                                <lightning-input type="checkbox" label="Trabajo único/puntual" checked={trabajoPuntual} onchange={handleTrabajoPuntualChange}></lightning-input>
                                <lightning-input type="checkbox" label="Venta producto" checked={ventaProducto} onchange={handleVentaProductoChange}></lightning-input>
                                <lightning-input type="checkbox" label="Contrato de mantenimiento" checked={trabajoMantenimiento} onchange={handleTrabajoMantenimientoChange}></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <p class="slds-text-title_bold">Observaciones sobre pago:</p>
                                    <lightning-button-menu label="Plantilla Pago" icon-name="utility:copy" variant="bare" onselect={handleApplyTemplate} data-field="observacionesPago">
                                        <template for:each={pagoTemplates} for:item="tpl">
                                            <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                        </template>
                                    </lightning-button-menu>
                                </div>
                                <lightning-input-rich-text value={observacionesPago} onchange={handleObservacionesPagoChange} variant="bottom-toolbar"></lightning-input-rich-text>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- PASO 4: PREVISUALIZACIÓN REALISTA -->
            <template if:true={isStep4}>
                <div class="pdf-preview-container">
                    <!-- PAGINACIÓN DINÁMICA BASADA EN SEPARADORES -->
                    <template for:each={serviciosPaginados} for:item="pagina" for:index="idx">
                        <div key={pagina.id} class="pdf-page slds-m-bottom_large">
                            <!-- HEADER (Se repite en cada hoja) -->
                            <div class="slds-m-bottom_large" style="margin: -3rem -3rem 2rem -3rem;">
                                <img src="/servlet/servlet.ImageServer?id=015V9000005wj9x&oid=00DV9000004in2j" style="width: 100%;">
                            </div>

                            <!-- DATOS DE CABECERA (Solo en la primera hoja) -->
                            <template if:true={pagina.isFirst}>
                                <div class="slds-p-horizontal_medium">
                                    <div style="font-size: 11pt; font-weight: bold; color: #0070d2;">{selectedLinesDisplay}</div>
                                    <div style="font-size: 9pt; color: #666;">
                                        <div><strong>Número de Presupuesto:</strong> {folio}</div>
                                        <div><strong>Creado por:</strong> {agenteNombre}</div>
                                        <div><strong>Fecha:</strong> {fechaFormateada}</div>
                                    </div>
                                    <div style="font-size: 14pt; font-weight: bold; margin-top: 10pt;">{selectedSedesDisplay}</div>
                                    <div style="font-size: 11pt; margin-top: 2pt;"><strong>Asunto:</strong> {asunto}</div>
                                </div>

                                <div class="slds-p-horizontal_medium slds-m-top_large" style="text-align: justify; font-size: 10pt;">
                                    <lightning-formatted-rich-text value={mergedIntroduccion}></lightning-formatted-rich-text>
                                </div>
                            </template>

                            <div class="pdf-section-title" style="margin-top: 20pt;">
                                <template if:true={pagina.titulo}>{pagina.titulo}</template>
                                <template if:false={pagina.titulo}>Servicios y Artículos</template>
                            </div>

                            <!-- TABLA DE PARTIDAS DE ESTA HOJA -->
                            <div class="slds-p-horizontal_medium">
                                <table class="slds-table slds-table_bordered slds-no-row-hover pdf-text-small">
                                    <thead>
                                        <tr>
                                            <th style="width: 45%; background-color: #f8f9fa;">CONCEPTO</th>
                                            <th style="width: 10%; text-align: center; background-color: #f8f9fa;">CANT</th>
                                            <th style="width: 15%; text-align: right; background-color: #f8f9fa;">P. UNITARIO</th>
                                            <template if:true={hasAnyDiscount}><th style="width: 10%; background-color: #f8f9fa;">DESC.</th></template>
                                            <th style="width: 20%; text-align: right; background-color: #f8f9fa;">IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template for:each={pagina.items} for:item="item">
                                            <tr key={item.id}>
                                                <td><strong>{item.descripcion}</strong></td>
                                                <td style="text-align: center;">{item.cantidad}</td>
                                                <td style="text-align: right;"><lightning-formatted-number value={item.importeUnitario} format-style="currency"></lightning-formatted-number></td>
                                                <template if:true={hasAnyDiscount}><td style="color: #d8000c;">{item.descuentoDisplay}</td></template>
                                                <td style="text-align: right;"><lightning-formatted-number value={item.totalSinImpuestos} format-style="currency"></lightning-formatted-number></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>

                            <!-- DETALLES TÉCNICOS DE ESTA HOJA -->
                            <div class="slds-p-horizontal_medium slds-m-top_medium">
                                <template for:each={pagina.items} for:item="item">
                                    <template if:true={item.detalleTecnicoHtml}>
                                        <div key={item.id} class="slds-m-bottom_small" style="border-bottom: 0.5pt solid #eee; padding-bottom: 4pt;">
                                            <div style="font-weight: bold; color: #0070d2; font-size: 9pt;">Detalle: {item.descripcion}</div>
                                            <div style="font-size: 9pt; color: #333; margin-top: 2pt; text-align: justify;">
                                                <lightning-formatted-rich-text value={item.detalleTecnicoHtml}></lightning-formatted-rich-text>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </div>

                            <!-- FOOTER DE PÁGINA (Solo en la última hoja) -->
                            <template if:true={pagina.isLast}>
                                <div class="slds-grid slds-grid_align-end slds-p-horizontal_medium slds-m-top_medium">
                                    <div class="slds-col slds-size_1-of-3">
                                        <table style="width: 100%;">
                                            <template for:each={totalesData} for:item="tot">
                                                <tr key={tot.id}><td style="color:#666;">Subtotal:</td><td align="right"><strong><lightning-formatted-number value={tot.base} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                                <tr key={tot.id}><td style="color:#d8000c;">Descuento:</td><td align="right" style="color:#d8000c;"><strong>- <lightning-formatted-number value={totalDescuento} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                                <tr key={tot.id}><td style="color:#666;">IVA (16%):</td><td align="right"><strong><lightning-formatted-number value={tot.valorImpuesto} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                                <tr key={tot.id}><td style="font-size:1.1rem; color:#0070d2;"><strong>TOTAL:</strong></td><td align="right" style="font-size:1.1rem; color:#0070d2; border-bottom:2pt solid #0070d2;"><strong><lightning-formatted-number value={tot.total} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                            </template>
                                        </table>
                                    </div>
                                </div>

                                <div class="pdf-section-title" style="margin-top: 25pt;">DATOS DE PAGO</div>
                                <div class="slds-p-horizontal_medium">
                                    <table style="width: 100%; border: 0.5pt solid #eee;">
                                        <thead>
                                            <tr>
                                                <th style="background-color: #D4EDDA; padding: 6pt; width: 25%; text-align: center;">Método de pago</th>
                                                <th style="background-color: #D4EDDA; padding: 6pt; width: 50%; text-align: center;">OBSERVACIONES SOBRE PAGOS</th>
                                                <th style="background-color: #D4EDDA; padding: 6pt; width: 25%; text-align: center;">TIPO DE TRABAJO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td align="center">{metodoPagoDisplay}</td>
                                                <td><lightning-formatted-rich-text value={observacionesPago}></lightning-formatted-rich-text></td>
                                                <td align="center">{tipoTrabajoDisplay}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <template if:true={showDescription}>
                                    <div class="slds-p-horizontal_medium slds-m-top_large slds-p-top_medium" style="border-top: 1pt solid #ccc;">
                                        <div style="font-weight: bold; text-transform: uppercase;">Condiciones / Anexos / Cláusulas</div>
                                        <div style="font-size: 9pt;"><lightning-formatted-rich-text value={mergedWarranty}></lightning-formatted-rich-text></div>
                                    </div>
                                </template>
                            </template>

                            <!-- PIE DE PÁGINA (Se repite en cada hoja) -->
                            <div class="page-footer-container">
                                <div class="slds-text-align_right slds-p-right_medium slds-text-color_weak" style="font-size: 8pt;">
                                    Hoja {pagina.num} de {serviciosPaginados.length}
                                </div>
                                <img src="/servlet/servlet.ImageServer?id=015V9000005wjDB&oid=00DV9000004in2j" style="width: 100%;">
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- FOOTER STICKY -->
        <div class="sticky-footer slds-p-around_medium bg-white border-top">
            <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                <!-- IZQUIERDA: REGRESAR + CLONAR -->
                <div class="slds-grid slds-grid_vertical-align-center">
                    <lightning-button label="Regresar" icon-name="utility:back" onclick={handleCancel}></lightning-button>
                    <div class="slds-m-left_medium slds-p-left_medium" style="border-left: 1px solid #dddbda;">
                        <lightning-button label="Clonar Cotización" icon-name="utility:copy" variant="neutral" onclick={handleCloneQuote}></lightning-button>
                    </div>
                </div>

                <!-- DERECHA: CONTRATO (SOLO PASO 4) + NAVEGACIÓN -->
                <div class="slds-grid slds-grid_vertical-align-center">
                    <template if:true={isStep4}>
                        <lightning-button label="Generar Contrato" icon-name="utility:justification_text" variant="brand-outline" class="slds-m-right_small" onclick={handleGenerateContract}></lightning-button>
                        <lightning-button label="Guardar Borrador" class="slds-m-right_small" onclick={handleSaveDraft}></lightning-button>
                        <lightning-button label="Finalizar" variant="brand" onclick={handleFinalize}></lightning-button>
                    </template>
                    <template if:false={isStep4}>
                        <lightning-button label="Siguiente" variant="brand" icon-name="utility:forward" icon-position="right" onclick={handleNext}></lightning-button>
                    </template>
                </div>
            </div>
        </div>

        <!-- MODAL SERVICIO (RESTAURADO COMPLETO) -->
        <template if:true={showModal}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium">
                <div class="slds-modal__container">
                    <header class="slds-modal__header custom-modal-header">
                        <h2 class="slds-text-heading_medium">Nueva linea del presupuesto</h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_large bg-light-gray">
                        <!-- FILTRO DINÁMICO POR LÍNEA -->
                        <div class="custom-checkbox-card slds-m-bottom_medium bg-white">
                            <lightning-input 
                                type="checkbox" 
                                label="Permitir agregar productos y servicios de otras lineas de negocio"
                                checked={allowOtherLines}
                                onchange={handleAllowOtherLinesChange}>
                            </lightning-input>
                        </div>

                        <div class="section-card slds-p-around_medium slds-m-bottom_medium">
                            <p class="slds-text-title_bold slds-m-bottom_x-small">Buscar articulo o servicio</p>
                            <div class="search-container">
                                <lightning-input type="search" placeholder="Escriba aquí para buscar..." variant="label-hidden" onchange={handleProductSearch} value={selectedProductName}></lightning-input>
                                <template if:true={searchResults.length}>
                                    <div class="product-search-results">
                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                            <template for:each={searchResults} for:item="res">
                                                <li key={res.id} role="presentation" class="slds-listbox__item product-result-item" onclick={handleProductSelect} data-id={res.id}>
                                                    <div class="slds-media slds-listbox__option slds-listbox__option_entity slds-listbox__option_has-meta" role="option">
                                                        <span class="slds-media__figure slds-listbox__option-icon">
                                                            <lightning-icon icon-name="standard:product" size="small"></lightning-icon>
                                                        </span>
                                                        <div class="slds-media__body">
                                                            <div class="slds-grid slds-grid_align-spread">
                                                                <span class="slds-listbox__option-text slds-listbox__option-text_entity product-name">{res.name}</span>
                                                                <span class="product-price">
                                                                    <lightning-formatted-number value={res.unitPrice} format-style="currency"></lightning-formatted-number>
                                                                </span>
                                                            </div>
                                                            <div class="slds-listbox__option-meta slds-listbox__option-meta_entity product-desc">{res.description}</div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>

                            <!-- NUEVO: OPCIONES DE LISTAS DE PRECIO -->
                            <template if:true={productPriceOptions.length}>
                                <div class="slds-m-top_medium">
                                    <p class="slds-text-title_bold slds-m-bottom_x-small">Listas de Precio Disponibles:</p>
                                    <div class="price-options-grid">
                                        <template for:each={productPriceOptions} for:item="opt">
                                            <div key={opt.pbeId} class={opt.className} onclick={handlePriceOptionSelect} data-id={opt.pbeId}>
                                                <div class="price-option-content">
                                                    <span class="price-option-name">{opt.pricebookName}</span>
                                                    <span class="price-option-value">
                                                        <lightning-formatted-number value={opt.unitPrice} format-style="currency"></lightning-formatted-number>
                                                    </span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="section-card slds-p-around_medium slds-m-bottom_medium">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-title_bold">¿Introducir precio unitario o el precio total?</span>
                                <div class="slds-grid">
                                    <lightning-input type="checkbox" label="UNITARIO" checked={isUnitario} onchange={handlePriceType} class="slds-m-right_large"></lightning-input>
                                    <lightning-input type="checkbox" label="TOTAL" checked={isTotal} onchange={handlePriceType}></lightning-input>
                                </div>
                            </div>
                            <div class="slds-m-top_medium">
                                <lightning-button label="Aplicar descuento" icon-name="utility:discount" variant="neutral" class="btn-azul-pastel" onclick={handleToggleDiscountColumn}></lightning-button>
                            </div>
                        </div>
                        <div class="section-card slds-m-bottom_none no-radius-bottom">
                            <!-- NUEVO: BUSCADOR Y SELECCIÓN MASIVA DENTRO DEL MODAL -->
                            <div class="slds-p-around_small bg-white border-bottom slds-grid slds-grid_vertical-align-center slds-grid_align-spread">
                                <div class="slds-size_2-of-3">
                                    <lightning-input 
                                        type="search" 
                                        placeholder="Filtrar sedes en esta lista..." 
                                        variant="label-hidden"
                                        onchange={handleModalSedeSearch}
                                        value={modalSedeSearchTerm}
                                        class="slds-m-right_small">
                                    </lightning-input>
                                </div>
                                <div class="slds-size_1-of-3 slds-text-align_right">
                                    <lightning-button-group>
                                        <lightning-button label="Todas" variant="neutral" onclick={handleSelectAllSedes} data-action="all"></lightning-button>
                                        <lightning-button label="Ninguna" variant="neutral" onclick={handleSelectAllSedes} data-action="none"></lightning-button>
                                    </lightning-button-group>
                                </div>
                            </div>

                            <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-no-row-hover">
                                <thead>
                                    <tr>
                                        <th scope="col" style="width: 3.5rem;">Incluir</th>
                                        <th scope="col">Sede</th>
                                        <th scope="col">Cantidad</th>
                                        <th scope="col">Importe</th>
                                        <template if:true={showDiscountColumn}><th scope="col">Descuento</th></template>
                                        <th scope="col">Total</th>
                                        <th scope="col">IVA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={filteredModalTableData} for:item="row">
                                        <tr key={row.id} class={row.rowClass}>
                                            <td>
                                                <lightning-input 
                                                    type="checkbox" 
                                                    checked={row.isSelected} 
                                                    data-id={row.id} 
                                                    onchange={handleSedeRowToggle}
                                                    variant="label-hidden">
                                                </lightning-input>
                                            </td>
                                            <td class="slds-text-title_bold">{row.sede}</td>
                                            <td><lightning-input type="number" value={row.cantidad} data-id={row.id} data-field="cantidad" onchange={handleModalInputChange} variant="label-hidden" style="width: 80px;" disabled={row.isDisabled}></lightning-input></td>
                                            <td><lightning-input type="number" formatter="currency" step="0.01" value={row.importeTotal} data-id={row.id} data-field="importeTotal" onchange={handleModalInputChange} variant="label-hidden" disabled={row.isDisabled}></lightning-input></td>
                                            <template if:true={showDiscountColumn}>
                                                <td>
                                                    <div class="slds-grid">
                                                        <lightning-input type="number" value={row.descuento} data-id={row.id} data-field="descuento" onchange={handleModalInputChange} variant="label-hidden" style="width: 70px;" disabled={row.isDisabled}></lightning-input>
                                                        <lightning-button-icon icon-name={row.tipoDescuentoIcon} onclick={handleToggleDiscountType} data-id={row.id} size="small" disabled={row.isDisabled}></lightning-button-icon>
                                                    </div>
                                                </td>
                                            </template>
                                            <td><lightning-formatted-number value={row.totalSinImpuestos} format-style="currency"></lightning-formatted-number></td>
                                            <td><lightning-input type="number" value={row.impuestos} data-id={row.id} data-field="impuestos" onchange={handleModalInputChange} variant="label-hidden" style="width: 60px;" disabled={row.isDisabled}></lightning-input></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="section-card slds-p-around_medium slds-m-bottom_medium no-radius-top border-top-none">
                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                <p class="slds-text-title_bold">Descripción adicional (será visible en el PDF):</p>
                                <lightning-button-menu label="Plantilla Técnica" icon-name="utility:description" variant="bare" onselect={handleApplyTemplate} data-field="modalDescription">
                                    <template for:each={serviceTemplates} for:item="tpl">
                                        <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                    </template>
                                </lightning-button-menu>
                            </div>
                            
                            <lightning-textarea 
                                value={modalDescription} 
                                onchange={handleModalDescriptionChange} 
                                variant="label-hidden"
                                class="custom-description-editor"
                                placeholder="Escriba aquí los detalles técnicos... (Use Enter para saltos de línea)">
                            </lightning-textarea>
                            
                            <div class="slds-m-top_medium">
                                <div class="custom-dropdown-trigger" onclick={toggleIndicaciones}>
                                    <lightning-icon icon-name={dropdownIcon} size="xx-small" class="slds-m-right_x-small"></lightning-icon>
                                    <span class="slds-text-title_bold">Indicaciones ejecución</span>
                                </div>
                                <template if:true={showIndicaciones}>
                                    <div class="slds-p-around_small slds-m-top_x-small bg-white border-all radius-8">
                                        <div class="chips-container slds-m-bottom_small">
                                            <template for:each={zonasAfectadas} for:item="zona">
                                                <span key={zona} class="slds-badge">{zona} <button data-name={zona} onclick={removeZona}>x</button></span>
                                            </template>
                                        </div>
                                        <lightning-input type="text" value={zonaInput} onchange={handleZonaInput} placeholder="Zona y coma..."></lightning-input>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <footer class="slds-modal__footer bg-white">
                        <lightning-button label="Cancelar" onclick={handleCloseModal} class="slds-m-right_x-small"></lightning-button>
                        <lightning-button label="Guardar y añadir otro" variant="neutral" onclick={handleSaveAndNext} class="slds-m-right_x-small"></lightning-button>
                        <lightning-button label="Guardar y Cerrar" variant="brand" onclick={handleSaveServiceLine}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- MODAL: SEPARADOR -->
        <template if:true={showSeparatorModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_x-small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header custom-modal-header"><h2 class="slds-text-heading_medium">Añadir Separador / Divisor</h2></header>
                    <div class="slds-modal__content slds-p-around_medium bg-light-gray">
                        <lightning-radio-group name="separatorType"
                            label="Tipo de Divisor"
                            options={separatorTypeOptions}
                            value={separatorType}
                            onchange={handleSeparatorTypeChange}
                            type="button">
                        </lightning-radio-group>

                        <template if:true={isSeparatorText}>
                            <div class="slds-m-top_medium">
                                <lightning-input label="Texto del Título" value={separatorText} onchange={handleSeparatorTextChange} placeholder="Ej: ZONA NORTE, FASE 2..."></lightning-input>
                            </div>
                        </template>
                        <template if:false={isSeparatorText}>
                            <div class="slds-m-top_medium slds-text-color_weak italic">
                                Se insertará una línea divisoria horizontal en el presupuesto.
                            </div>
                        </template>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button label="Cancelar" onclick={handleCloseSeparatorModal} class="slds-m-right_x-small"></lightning-button>
                        <lightning-button label="Añadir Divisor" variant="brand" onclick={handleAddSeparator}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- MODAL: P&L -->
        <template if:true={showPasswordModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_x-small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header"><h2>Acceso Restringido</h2></header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-input type="password" label="Clave" value={passwordInput} onchange={handlePasswordChange}></lightning-input>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button label="Desbloquear" variant="brand" onclick={handleValidatePLPassword}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showPLModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_medium">
                <div class="slds-modal__container" style="max-width: 90%; width: 900px;">
                    <header class="slds-modal__header bg-blue-dark text-white">
                        <h2 class="slds-text-heading_medium">Dashboard de Análisis de Rentabilidad</h2>
                        <p class="slds-text-title">Comparativa de Operación: Año 1 vs Año 2</p>
                    </header>
                    <div class="slds-modal__content slds-p-around_none">
                        <table class="pl-table">
                            <thead>
                                <tr>
                                    <th style="text-align: left; padding-left: 20px;">CONCEPTO / INDICADOR</th>
                                    <th>SERV / AÑO 1</th>
                                    <th>SERV / AÑO 2</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- GRUPO 1: ENTRADAS -->
                                <tr class="pl-section-header">
                                    <td colspan="3">1. CAMPOS DE CAPTURA (DATOS DE ENTRADA)</td>
                                </tr>
                                <tr>
                                    <td>COSTO DIRECTO (Materiales + MO)</td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl1.costo} data-field="costo" onchange={handlePL1Change} formatter="currency" step="0.01"></lightning-input></td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl2.costo} data-field="costo" onchange={handlePL2Change} formatter="currency" step="0.01"></lightning-input></td>
                                </tr>
                                <tr>
                                    <td>MARGEN ESPERADO (%)</td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl1.margen} data-field="margen" onchange={handlePL1Change} step="0.01"></lightning-input></td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl2.margen} data-field="margen" onchange={handlePL2Change} step="0.01"></lightning-input></td>
                                </tr>
                                <tr class="bg-blue-soft">
                                    <td class="slds-font-weight_bold">PRECIO DE VENTA SUGERIDO</td>
                                    <td class="pl-calculated-value text-blue" style="font-size: 1.1rem;">${res1.venta}</td>
                                    <td class="pl-calculated-value text-blue" style="font-size: 1.1rem;">${res2.venta}</td>
                                </tr>

                                <!-- GRUPO 2: GASTOS -->
                                <tr class="pl-section-header">
                                    <td colspan="3">2. GASTOS OPERATIVOS E INDIRECTOS</td>
                                </tr>
                                <tr>
                                    <td>Indirecto (15%)</td>
                                    <td class="pl-calculated-value">${res1.ind}</td>
                                    <td class="pl-calculated-value">${res2.ind}</td>
                                </tr>
                                <tr>
                                    <td>Comisión Comercial (2%)</td>
                                    <td class="pl-calculated-value">${res1.com1}</td>
                                    <td class="pl-calculated-value">${res2.com1}</td>
                                </tr>
                                <tr>
                                    <td>Comisión 2 (%)</td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl1.comision2} data-field="comision2" onchange={handlePL1Change} step="0.01"></lightning-input></td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl2.comision2} data-field="comision2" onchange={handlePL2Change} step="0.01"></lightning-input></td>
                                </tr>
                                <tr class="bg-light-gray">
                                    <td>Monto Comisión 2</td>
                                    <td class="pl-calculated-value">${res1.com2}</td>
                                    <td class="pl-calculated-value">${res2.com2}</td>
                                </tr>
                                <tr>
                                    <td>Regalía Franquicia (5%)</td>
                                    <td class="pl-calculated-value">${res1.reg}</td>
                                    <td class="pl-calculated-value">${res2.reg}</td>
                                </tr>
                                <tr>
                                    <td>Días de Financiamiento</td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl1.dias} data-field="dias" onchange={handlePL1Change}></lightning-input></td>
                                    <td class="pl-input-cell"><lightning-input type="number" variant="label-hidden" value={pl2.dias} data-field="dias" onchange={handlePL2Change}></lightning-input></td>
                                </tr>
                                <tr class="bg-light-gray">
                                    <td>Costo Financiamiento</td>
                                    <td class="pl-calculated-value">${res1.fin}</td>
                                    <td class="pl-calculated-value">${res2.fin}</td>
                                </tr>

                                <!-- GRUPO 3: IMPUESTOS -->
                                <tr class="pl-section-header">
                                    <td colspan="3">3. IMPUESTOS (BASADOS EN UTILIDAD BRUTA)</td>
                                </tr>
                                <tr>
                                    <td>ISR (6% s/Utilidad)</td>
                                    <td class="pl-calculated-value">${res1.isr}</td>
                                    <td class="pl-calculated-value">${res2.isr}</td>
                                </tr>
                                <tr>
                                    <td>RU (5% s/Utilidad)</td>
                                    <td class="pl-calculated-value">${res1.ru}</td>
                                    <td class="pl-calculated-value">${res2.ru}</td>
                                </tr>

                                <!-- TOTALES FINALES -->
                                <tr class="pl-result-row">
                                    <td class="slds-font-weight_bold" style="font-size: 1rem;">COSTO TOTAL DE OPERACIÓN</td>
                                    <td class="pl-calculated-value" style="font-size: 1rem;">${res1.costoTotal}</td>
                                    <td class="pl-calculated-value" style="font-size: 1rem;">${res2.costoTotal}</td>
                                </tr>
                                <tr class="bg-green-soft">
                                    <td class="slds-text-heading_small slds-font-weight_bold">UTILIDAD NETA FINAL (Margen Real)</td>
                                    <td class="slds-text-align_right">
                                        <span class="pl-profit" style="font-size: 1.2rem;">${res1.resPesos}</span>
                                        <div class="slds-text-title_bold text-muted">{res1.resPct}%</div>
                                    </td>
                                    <td class="slds-text-align_right">
                                        <span class="pl-profit" style="font-size: 1.2rem;">${res2.resPesos}</span>
                                        <div class="slds-text-title_bold text-muted">{res2.resPct}%</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- SECCIÓN: RESPALDO DOCUMENTAL DEL P&L -->
                        <div class="slds-m-top_large slds-p-around_medium bg-white border-all radius-8 shadow-inner">
                            <div class="slds-grid slds-grid_vertical-align-center slds-m-bottom_small">
                                <lightning-icon icon-name="utility:attach" size="x-small" class="slds-m-right_small icon-blue"></lightning-icon>
                                <span class="slds-text-title_bold text-blue">Documentación de Respaldo (Cotizaciones / Soporte)</span>
                            </div>
                            <template if:true={recordId}>
                                <lightning-file-upload
                                    label="Adjunte aquí el PDF de soporte del P&L"
                                    name="fileUploaderPL"
                                    accept=".pdf,.png,.jpg,.jpeg"
                                    record-id={recordId}
                                    onuploadfinished={handleUploadFinished}
                                    multiple>
                                </lightning-file-upload>
                            </template>
                            <template if:false={recordId}>
                                <div class="slds-box slds-theme_shade slds-text-align_center">
                                    <p class="text-muted italic">Guarde el borrador para habilitar la carga de documentos en este análisis.</p>
                                </div>
                            </template>
                        </div>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button label="Cerrar Análisis P&L" variant="neutral" onclick={handleClosePLModal}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </div>
</template>