<template>
    <div class="main-container">
        <!-- HEADER CON PROGRESO -->
        <div class="slds-p-around_medium bg-white border-bottom">
            <lightning-progress-indicator current-step={currentStep} type="path" variant="base">
                <lightning-progress-step label="Contrato" value="1"></lightning-progress-step>
                <lightning-progress-step label="Datos Técnicos" value="2"></lightning-progress-step>
                <lightning-progress-step label="Detalles" value="3"></lightning-progress-step>
                <lightning-progress-step label="Finalizar" value="4"></lightning-progress-step>
            </lightning-progress-indicator>
        </div>

        <div class="slds-p-around_large content-area">
            
            <!-- PASO 1: ORIGEN Y ESTRATEGIA -->
            <template if:true={isStep1}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <h2 class="slds-text-heading_small">Estrategia de Venta</h2>
                        </div>
                    </div>
                    <div class="slds-p-around_large">
                        <lightning-radio-group name="estrategiaVenta"
                            label="Categoría"
                            options={estrategiaOptions}
                            value={estrategiaVenta}
                            onchange={handleEstrategiaChange}
                            type="button"
                            variant="label-hidden"
                            class="custom-radio-group">
                        </lightning-radio-group>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <h2 class="slds-text-heading_small">Origen: Necesidad o Levantamiento</h2>
                        </div>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters slds-grid_vertical-align-end">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_2-of-3" style="position: relative;">
                                <lightning-input type="search" label="Buscar Necesidad / Levantamiento relacionado" 
                                    placeholder="Escriba el nombre o folio..."
                                    onchange={handleNecesidadChange}
                                    value={necesidadSeleccionada}>
                                </lightning-input>
                                <template if:true={necesidadesResults.length}>
                                    <div class="slds-dropdown slds-dropdown_fluid slds-p-around_xx-small" style="position: absolute; display: block; z-index: 9999;">
                                        <ul class="slds-listbox slds-listbox_vertical" role="presentation">
                                            <template for:each={necesidadesResults} for:item="n">
                                                <li key={n.id} role="presentation" class="slds-listbox__item" onclick={handleNecesidadSelect} data-id={n.id}>
                                                    <div class="slds-media slds-listbox__option slds-listbox__option_plain" role="option">
                                                        <span class="slds-media__body">
                                                            <span class="slds-truncate" title={n.name}>{n.name}</span>
                                                        </span>
                                                    </div>
                                                </li>
                                            </template>
                                        </ul>
                                    </div>
                                </template>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3">
                                <lightning-button label="Nuevo Levantamiento" icon-name="utility:add" variant="neutral" class="slds-size_1-of-1"></lightning-button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- PASO 2: DATOS TÉCNICOS -->
            <template if:true={isStep2}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <lightning-icon icon-name="utility:info" size="small" class="slds-m-right_small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Información del Presupuesto</h2>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <lightning-input type="text" label="Número de Presupuesto" value={folio} readonly></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <lightning-input type="text" label="Asunto" value={asunto} onchange={handleAsuntoChange}></lightning-input>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header slds-grid slds-grid_align-spread">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <lightning-icon icon-name="utility:announcement" size="small" class="slds-m-right_small"></lightning-icon>
                            <h2 class="slds-text-heading_small">Introducción</h2>
                        </div>
                        <lightning-button-menu label="Cargar Plantilla" icon-name="utility:insert_tag_field" variant="border-filled" onselect={handleApplyTemplate} data-field="introduccion">
                            <template for:each={introTemplates} for:item="tpl">
                                <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                            </template>
                        </lightning-button-menu>
                    </div>
                    <div class="slds-p-around_large">
                        <lightning-input-rich-text value={introduccion} onchange={handleIntroChange} variant="bottom-toolbar"></lightning-input-rich-text>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header">
                        <lightning-icon icon-name="utility:tower" size="small" class="slds-m-right_small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Línea de Negocio</h2>
                    </div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap">
                            <template for:each={lineaNegocioOptions} for:item="option">
                                <div key={option.value} class="slds-col slds-size_1-of-2 slds-medium-size_1-of-4 slds-p-around_xx-small">
                                    <div class="custom-checkbox-card">
                                        <lightning-input type="checkbox" label={option.label} data-value={option.value} checked={option.checked} onchange={handleLineChange}></lightning-input>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header"><h2 class="slds-text-heading_small">Seleccionar Sede</h2></div>
                    <div class="datatable-container scrollable-table">
                        <lightning-datatable key-field="Id" data={sedesData} columns={sedesColumns} selected-rows={selectedSedesIds} onrowselection={handleSedeSelection} max-row-selection="1"></lightning-datatable>
                    </div>
                </div>
            </template>

            <!-- PASO 3: DETALLES -->
            <template if:true={isStep3}>
                <div class="section-card slds-m-bottom_large">
                    <div class="section-header"><h2 class="slds-text-heading_small">Servicios/Artículos</h2></div>
                    <div class="slds-p-around_none datatable-container">
                        <lightning-datatable key-field="id" data={serviciosData} columns={serviciosColumns} hide-checkbox-column></lightning-datatable>
                        <div class="slds-p-around_medium slds-grid slds-grid_align-spread bg-white border-bottom">
                            <div class="slds-grid">
                                <lightning-button label="+ Añadir servicios" variant="success" class="btn-verde slds-m-right_small" onclick={handleOpenModal}></lightning-button>
                                <lightning-button label="+ Añadir Separador" variant="success" class="btn-verde" onclick={handleOpenSeparatorModal}></lightning-button>
                            </div>
                            <lightning-button label="P&L" icon-name="utility:calculator" class="btn-azul-pastel" onclick={handleOpenPLModal}></lightning-button>
                        </div>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="slds-p-around_medium">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <div class="blue-square slds-m-right_small"></div>
                            <lightning-input type="checkbox" label="Añadir descripción / explicación" checked={showDescription} onchange={handleShowDescriptionChange}></lightning-input>
                        </div>
                        <template if:true={showDescription}>
                            <div class="slds-m-top_medium slds-p-around_small border-all radius-8 bg-light-gray">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <p class="slds-text-title_bold">Condiciones / Anexos / Cláusulas:</p>
                                    <lightning-button-menu label="Usar Plantilla" icon-name="utility:copy" variant="bare" onselect={handleApplyTemplate} data-field="warranty">
                                        <template for:each={warrantyTemplates} for:item="tpl">
                                            <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                        </template>
                                    </lightning-button-menu>
                                </div>
                                <lightning-input-rich-text value={warranty} onchange={handleWarrantyChange} variant="bottom-toolbar"></lightning-input-rich-text>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="section-card slds-m-bottom_large">
                    <div class="section-header"><h2 class="slds-text-heading_small">Método de Pago</h2></div>
                    <div class="slds-p-around_large">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <p class="slds-text-title_bold">Opciones de Pago</p>
                                <lightning-input type="checkbox" label="Transferencia" checked={pagoTransferencia} onchange={handlePagoTransferenciaChange}></lightning-input>
                                <lightning-input type="checkbox" label="Tarjeta" checked={pagoTarjeta} onchange={handlePagoTarjetaChange}></lightning-input>
                                
                                <p class="slds-text-title_bold slds-m-top_medium">TIPO DE TRABAJO:</p>
                                <lightning-input type="checkbox" label="Trabajo único/puntual" checked={trabajoPuntual} onchange={handleTrabajoPuntualChange}></lightning-input>
                                <lightning-input type="checkbox" label="Venta producto" checked={ventaProducto} onchange={handleVentaProductoChange}></lightning-input>
                                <lightning-input type="checkbox" label="Contrato de mantenimiento" checked={trabajoMantenimiento} onchange={handleTrabajoMantenimientoChange}></lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2">
                                <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                    <p class="slds-text-title_bold">Observaciones sobre pago:</p>
                                    <lightning-button-menu label="Plantilla Pago" icon-name="utility:copy" variant="bare" onselect={handleApplyTemplate} data-field="observacionesPago">
                                        <template for:each={pagoTemplates} for:item="tpl">
                                            <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                        </template>
                                    </lightning-button-menu>
                                </div>
                                <lightning-input-rich-text value={observacionesPago} onchange={handleObservacionesPagoChange} variant="bottom-toolbar"></lightning-input-rich-text>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- PASO 4: PREVISUALIZACIÓN -->
            <template if:true={isStep4}>
                <div class="pdf-preview-container radius-8">
                    <div class="pdf-page">
                        <div class="slds-m-bottom_large" style="margin: -3rem -3rem 2rem -3rem;">
                            <img src="/servlet/servlet.ImageServer?id=015V9000005wj9x&oid=00DV9000004in2j" style="width: 100%;">
                        </div>

                        <div class="slds-p-horizontal_medium">
                            <div style="font-size: 11pt; font-weight: bold; color: #0070d2;">{selectedLinesDisplay}</div>
                            <div style="font-size: 9pt; color: #666;">
                                <div><strong>Número de Presupuesto:</strong> {folio}</div>
                                <div><strong>Creado por:</strong> {agenteNombre}</div>
                                <div><strong>Fecha:</strong> {fechaFormateada}</div>
                            </div>
                            <div style="font-size: 14pt; font-weight: bold; margin-top: 10pt;">{selectedSedesDisplay}</div>
                            <div style="font-size: 11pt; margin-top: 2pt;"><strong>Asunto:</strong> {asunto}</div>
                        </div>

                        <div class="slds-p-horizontal_medium slds-m-top_large" style="text-align: justify; font-size: 10pt;">
                            <lightning-formatted-rich-text value={mergedIntroduccion}></lightning-formatted-rich-text>
                        </div>

                        <div class="pdf-section-title" style="margin-top: 20pt;">Servicios y Artículos</div>
                        <div class="slds-p-horizontal_medium">
                            <table class="slds-table slds-table_bordered slds-no-row-hover pdf-text-small">
                                <thead>
                                    <tr>
                                        <th style="width: 45%; background-color: #f8f9fa;">CONCEPTO</th>
                                        <th style="width: 10%; text-align: center; background-color: #f8f9fa;">CANT</th>
                                        <th style="width: 15%; text-align: right; background-color: #f8f9fa;">P. UNITARIO</th>
                                        <template if:true={hasAnyDiscount}><th style="width: 10%; background-color: #f8f9fa;">DESC.</th></template>
                                        <th style="width: 20%; text-align: right; background-color: #f8f9fa;">IMPORTE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={serviciosData} for:item="item">
                                        <tr key={item.id}>
                                            <td>
                                                <strong>{item.descripcion}</strong>
                                                <template if:true={item.detalleTecnicoHtml}>
                                                    <div class="slds-m-top_xx-small slds-text-color_weak" style="font-size: 8pt; font-style: italic;">
                                                        <lightning-formatted-rich-text value={item.detalleTecnicoHtml}></lightning-formatted-rich-text>
                                                    </div>
                                                </template>
                                            </td>
                                            <td style="text-align: center;">{item.cantidad}</td>
                                            <td style="text-align: right;"><lightning-formatted-number value={item.importeUnitario} format-style="currency"></lightning-formatted-number></td>
                                            <template if:true={hasAnyDiscount}><td style="color: #d8000c;">{item.descuentoDisplay}</td></template>
                                            <td style="text-align: right;"><lightning-formatted-number value={item.totalSinImpuestos} format-style="currency"></lightning-formatted-number></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <div class="slds-grid slds-grid_align-end slds-p-horizontal_medium slds-m-top_medium">
                            <div class="slds-col slds-size_1-of-3">
                                <table style="width: 100%;">
                                    <template for:each={totalesData} for:item="tot">
                                        <tr key={tot.id}><td style="color:#666;">Subtotal:</td><td align="right"><strong><lightning-formatted-number value={tot.base} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                        <tr key={tot.id}><td style="color:#d8000c;">Descuento:</td><td align="right" style="color:#d8000c;"><strong>- <lightning-formatted-number value={totalDescuento} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                        <tr key={tot.id}><td style="color:#666;">IVA (16%):</td><td align="right"><strong><lightning-formatted-number value={tot.valorImpuesto} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                        <tr key={tot.id}><td style="font-size:1.1rem; color:#0070d2;"><strong>TOTAL:</strong></td><td align="right" style="font-size:1.1rem; color:#0070d2; border-bottom:2pt solid #0070d2;"><strong><lightning-formatted-number value={tot.total} format-style="currency"></lightning-formatted-number></strong></td></tr>
                                    </template>
                                </table>
                            </div>
                        </div>

                        <div class="pdf-section-title" style="margin-top: 25pt;">DATOS DE PAGO</div>
                        <div class="slds-p-horizontal_medium">
                            <table style="width: 100%; border: 0.5pt solid #eee;">
                                <thead>
                                    <tr>
                                        <th style="background-color: #D4EDDA; padding: 6pt; width: 25%; text-align: center;">Método de pago</th>
                                        <th style="background-color: #D4EDDA; padding: 6pt; width: 50%; text-align: center;">OBSERVACIONES SOBRE PAGOS</th>
                                        <th style="background-color: #D4EDDA; padding: 6pt; width: 25%; text-align: center;">TIPO DE TRABAJO</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td align="center">{metodoPagoDisplay}</td>
                                        <td><lightning-formatted-rich-text value={observacionesPago}></lightning-formatted-rich-text></td>
                                        <td align="center">{tipoTrabajoDisplay}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <template if:true={showDescription}>
                            <div class="slds-p-horizontal_medium slds-m-top_large slds-p-top_medium" style="border-top: 1pt solid #ccc;">
                                <div style="font-weight: bold; text-transform: uppercase;">Condiciones / Anexos / Cláusulas</div>
                                <div style="font-size: 9pt;"><lightning-formatted-rich-text value={mergedWarranty}></lightning-formatted-rich-text></div>
                            </div>
                        </template>

                        <div style="margin-top: 50pt;"><img src="/servlet/servlet.ImageServer?id=015V9000005wjDB&oid=00DV9000004in2j" style="width: 100%;"></div>
                    </div>
                </div>
            </template>
        </div>

        <!-- FOOTER STICKY -->
        <div class="sticky-footer slds-p-around_medium bg-white border-top">
            <div class="slds-grid slds-grid_align-spread">
                <lightning-button label="Regresar" icon-name="utility:back" onclick={handleCancel}></lightning-button>
                <div class="slds-grid">
                    <template if:true={isStep4}>
                        <lightning-button label="Guardar Borrador" class="slds-m-right_small" onclick={handleSaveDraft}></lightning-button>
                        <lightning-button label="Finalizar" variant="brand" onclick={handleFinalize}></lightning-button>
                    </template>
                    <template if:false={isStep4}>
                        <lightning-button label="Siguiente" variant="brand" onclick={handleNext}></lightning-button>
                    </template>
                </div>
            </div>
        </div>

        <!-- MODAL SERVICIO (RESTAURADO COMPLETO) -->
        <template if:true={showModal}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_medium">
                <div class="slds-modal__container">
                    <header class="slds-modal__header custom-modal-header">
                        <h2 class="slds-text-heading_medium">Nueva linea del presupuesto</h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_large bg-light-gray">
                        <div class="section-card slds-p-around_medium slds-m-bottom_medium">
                            <p class="slds-text-title_bold slds-m-bottom_x-small">Buscar articulo o servicio</p>
                            <lightning-input type="search" placeholder="Escriba aquí para buscar..." variant="label-hidden" onchange={handleProductSearch} value={selectedProductName}></lightning-input>
                            <template if:true={searchResults.length}>
                                <div class="slds-dropdown slds-dropdown_fluid slds-p-around_xx-small" style="position: relative; display: block;">
                                    <ul class="slds-listbox slds-listbox_vertical">
                                        <template for:each={searchResults} for:item="res">
                                            <li key={res.id} class="slds-listbox__item" onclick={handleProductSelect} data-id={res.id}>{res.name} - <lightning-formatted-number value={res.unitPrice} format-style="currency"></lightning-formatted-number></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                        <div class="section-card slds-p-around_medium slds-m-bottom_medium">
                            <div class="slds-grid slds-grid_align-spread">
                                <span class="slds-text-title_bold">¿Introducir precio unitario o el precio total?</span>
                                <div class="slds-grid">
                                    <lightning-input type="checkbox" label="UNITARIO" checked={isUnitario} onchange={handlePriceType} class="slds-m-right_large"></lightning-input>
                                    <lightning-input type="checkbox" label="TOTAL" checked={isTotal} onchange={handlePriceType}></lightning-input>
                                </div>
                            </div>
                            <div class="slds-m-top_medium">
                                <lightning-button label="Aplicar descuento" icon-name="utility:discount" variant="neutral" class="btn-azul-pastel" onclick={handleToggleDiscountColumn}></lightning-button>
                            </div>
                        </div>
                        <div class="section-card slds-m-bottom_none no-radius-bottom">
                            <table class="slds-table slds-table_bordered slds-table_cell-buffer slds-no-row-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Sede</th>
                                        <th scope="col">Cantidad</th>
                                        <th scope="col">Importe</th>
                                        <template if:true={showDiscountColumn}><th scope="col">Descuento</th></template>
                                        <th scope="col">Total</th>
                                        <th scope="col">IVA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template for:each={modalTableData} for:item="row">
                                        <tr key={row.id}>
                                            <td class="slds-text-title_bold">{row.sede}</td>
                                            <td><lightning-input type="number" value={row.cantidad} data-id={row.id} data-field="cantidad" onchange={handleModalInputChange} variant="label-hidden" style="width: 80px;"></lightning-input></td>
                                            <td><lightning-input type="number" formatter="currency" step="0.01" value={row.importeTotal} data-id={row.id} data-field="importeTotal" onchange={handleModalInputChange} variant="label-hidden"></lightning-input></td>
                                            <template if:true={showDiscountColumn}>
                                                <td>
                                                    <div class="slds-grid">
                                                        <lightning-input type="number" value={row.descuento} data-id={row.id} data-field="descuento" onchange={handleModalInputChange} variant="label-hidden" style="width: 70px;"></lightning-input>
                                                        <lightning-button-icon icon-name={row.tipoDescuentoIcon} onclick={handleToggleDiscountType} data-id={row.id} size="small"></lightning-button-icon>
                                                    </div>
                                                </td>
                                            </template>
                                            <td><lightning-formatted-number value={row.totalSinImpuestos} format-style="currency"></lightning-formatted-number></td>
                                            <td><lightning-input type="number" value={row.impuestos} data-id={row.id} data-field="impuestos" onchange={handleModalInputChange} variant="label-hidden" style="width: 60px;"></lightning-input></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                        <div class="section-card slds-p-around_medium slds-m-bottom_medium no-radius-top border-top-none">
                            <div class="slds-grid slds-grid_align-spread slds-m-bottom_small">
                                <p class="slds-text-title_bold">Descripción adicional:</p>
                                <lightning-button-menu label="Plantilla Técnica" icon-name="utility:description" variant="bare" onselect={handleApplyTemplate} data-field="modalDescription">
                                    <template for:each={serviceTemplates} for:item="tpl">
                                        <lightning-menu-item key={tpl.id} value={tpl.id} label={tpl.name}></lightning-menu-item>
                                    </template>
                                </lightning-button-menu>
                            </div>
                            <lightning-input-rich-text value={modalDescription} onchange={handleModalDescriptionChange} variant="bottom-toolbar"></lightning-input-rich-text>
                            
                            <div class="slds-m-top_medium">
                                <div class="custom-dropdown-trigger" onclick={toggleIndicaciones}>
                                    <lightning-icon icon-name={dropdownIcon} size="xx-small" class="slds-m-right_x-small"></lightning-icon>
                                    <span class="slds-text-title_bold">Indicaciones ejecución</span>
                                </div>
                                <template if:true={showIndicaciones}>
                                    <div class="slds-p-around_small slds-m-top_x-small bg-white border-all radius-8">
                                        <div class="chips-container slds-m-bottom_small">
                                            <template for:each={zonasAfectadas} for:item="zona">
                                                <span key={zona} class="slds-badge">{zona} <button data-name={zona} onclick={removeZona}>x</button></span>
                                            </template>
                                        </div>
                                        <lightning-input type="text" value={zonaInput} onchange={handleZonaInput} placeholder="Zona y coma..."></lightning-input>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <footer class="slds-modal__footer bg-white">
                        <lightning-button label="Cancelar" onclick={handleCloseModal} class="slds-m-right_x-small"></lightning-button>
                        <lightning-button label="Guardar Línea" variant="brand" onclick={handleSaveServiceLine}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- MODAL: SEPARADOR -->
        <template if:true={showSeparatorModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_x-small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header"><h2 class="slds-text-heading_medium">Añadir Separador</h2></header>
                    <div class="slds-modal__content slds-p-around_medium bg-light-gray">
                        <lightning-input label="Texto" value={separatorText} onchange={handleSeparatorTextChange}></lightning-input>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button label="Cancelar" onclick={handleCloseSeparatorModal} class="slds-m-right_x-small"></lightning-button>
                        <lightning-button label="Añadir" variant="brand" onclick={handleAddSeparator}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <!-- MODAL: P&L -->
        <template if:true={showPasswordModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_x-small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header"><h2>Acceso Restringido</h2></header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-input type="password" label="Clave" value={passwordInput} onchange={handlePasswordChange}></lightning-input>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button label="Desbloquear" variant="brand" onclick={handleValidatePLPassword}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showPLModal}>
            <section class="slds-modal slds-fade-in-open slds-modal_small">
                <div class="slds-modal__container">
                    <header class="slds-modal__header"><h2>P&L Interno</h2></header>
                    <div class="slds-modal__content slds-p-around_large bg-light-gray">
                        <div class="slds-grid slds-wrap">
                            <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                                <p>Total: <lightning-formatted-number value={totalVentaNeto} format-style="currency"></lightning-formatted-number></p>
                                <lightning-input type="number" label="Costo" value={costoOperativo} onchange={handleCostoChange}></lightning-input>
                                <p style={marginStyle}>Margen: {margenActual}%</p>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-p-around_small">
                                <lightning-input type="number" label="% Utilidad" value={utilidadDeseada} onchange={handleUtilidadDeseadaChange}></lightning-input>
                                <p>Sugerido: <lightning-formatted-number value={precioSugerido} format-style="currency"></lightning-formatted-number></p>
                            </div>
                        </div>
                    </div>
                    <footer class="slds-modal__footer"><lightning-button label="Cerrar" onclick={handleClosePLModal}></lightning-button></footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
    </div>
</template>